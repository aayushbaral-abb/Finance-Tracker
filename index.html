<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker</title>
    <link rel="Shortcut icon" href="logo.png" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <!-- CSS: Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal Animation */
        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col">

    <!-- APP CONTAINER -->
    <div id="app" class="flex-grow flex flex-col">
        <!-- Content injected by JS -->
    </div>

    <!-- ERROR/HELP MODAL (Hidden by default) -->
    <div id="errorModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full m-4 p-6 modal-fade-in">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                <h3 class="text-xl font-bold">Action Required</h3>
            </div>
            <p id="errorModalBody" class="text-gray-600 mb-4 text-sm break-words">
                <!-- Message injected here -->
            </p>
            
            <!-- Code Box for Rules -->
            <div id="rulesBox" class="hidden">
                <p class="text-sm font-semibold text-gray-700 mb-2">1. Go to Firebase Console -> Firestore Database -> Rules</p>
                <p class="text-sm font-semibold text-gray-700 mb-2">2. Paste this code and click Publish:</p>
                <div class="relative group">
                    <pre class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</pre>
                    <button onclick="window.copyRules()" class="absolute top-2 right-2 bg-gray-700 text-white text-xs px-2 py-1 rounded hover:bg-gray-600">Copy</button>
                </div>
            </div>

            <div class="mt-6 text-right">
                <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
                    OK, I'll Fix It
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            reauthenticateWithCredential,
            updatePassword,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            orderBy, 
            onSnapshot,
            deleteDoc,
            doc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCzM-KT4fFG1dEM1eH75FQsFobAFxxfgRU",
            authDomain: "finance-tracker-3aaf2.firebaseapp.com",
            projectId: "finance-tracker-3aaf2",
            storageBucket: "finance-tracker-3aaf2.firebasestorage.app",
            messagingSenderId: "429587932344",
            appId: "1:429587932344:web:4051dda9ee6c66fcfdc04d",
            measurementId: "G-RGSX7K7XDS"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error. Did you update the config?", e);
            document.body.innerHTML = `<div class="p-10 text-center text-red-600 font-bold">Error: Firebase Config Invalid. Please open index.html and update the firebaseConfig object.</div>`;
        }

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        const state = {
            user: null,
            transactions: [],
            view: 'auth', // auth, dashboard
            authMode: 'login', // login only now
            activeTab: 'statement', // statement, credit, debit, settings
            editingId: null, // ID of transaction being edited
            loading: false,
            submitting: false, // For button states
            error: '',
            successMsg: ''
        };

        // Listener cleanup variable
        let unsubscribeSnapshot = null;

        // ==========================================
        // UTILS
        // ==========================================
        window.showErrorModal = (message, showRules = false) => {
            const modal = document.getElementById('errorModal');
            const body = document.getElementById('errorModalBody');
            const rulesBox = document.getElementById('rulesBox');
            
            body.innerHTML = message;
            if (showRules) {
                rulesBox.classList.remove('hidden');
            } else {
                rulesBox.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        };

        window.copyRules = () => {
            const rules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}`;
            navigator.clipboard.writeText(rules).then(() => {
                alert("Rules copied to clipboard!");
            });
        };

        // ==========================================
        // UI RENDERING
        // ==========================================
        const appDiv = document.getElementById('app');

        function render() {
            appDiv.innerHTML = '';
            
            if (state.loading) {
                appDiv.innerHTML = `<div class="flex h-screen items-center justify-center"><div class="loader"></div></div>`;
                return;
            }

            if (!state.user) {
                renderAuth();
            } else {
                renderDashboard();
            }
        }

        function renderAuth() {
            // Simplified Auth: Login only
            let title = 'Finance Tracker (NPR)';
            let btnText = 'Login';
            
            if (state.submitting) {
                btnText = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
            }

            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <div class="text-center mb-6">
                            <h1 class="text-3xl font-bold text-indigo-900">${title}</h1>
                            <p class="text-gray-500">Your daily financial record keeping app.</p>
                        </div>
                        
                        ${state.error ? `<div class="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm font-medium border border-red-200"><i class="fa-solid fa-circle-exclamation mr-2"></i>${state.error}</div>` : ''}
                        ${state.successMsg ? `<div class="bg-green-100 text-green-700 p-3 rounded mb-4 text-sm font-medium border border-green-200"><i class="fa-solid fa-check-circle mr-2"></i>${state.successMsg}</div>` : ''}

                        <form id="authForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required placeholder="example@gmail.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" placeholder="Enter your password" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required minlength="6">
                            </div>
                            
                            <button type="submit" ${state.submitting ? 'disabled' : ''} class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                ${btnText}
                            </button>
                        </form>

                        <div class="mt-6 text-center text-sm space-y-2 border-t pt-4">
                            <p class="text-gray-600 font-medium">If you want to create your account contact owner.</p>
                            <p>
                                <a href="https://baralaayush.com.np/#contact" target="_blank" class="text-indigo-600 font-bold hover:underline flex items-center justify-center gap-2">
                                    <span>ðŸ‘‰</span> Send Message
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
        }

        function renderDashboard() {
            // Calculate Totals
            const totalCredit = state.transactions
                .filter(t => t.type === 'CREDIT')
                .reduce((sum, t) => sum + Number(t.amount), 0);
            
            const totalDebit = state.transactions
                .filter(t => t.type === 'DEBIT')
                .reduce((sum, t) => sum + Number(t.amount), 0);
            
            const balance = totalCredit - totalDebit;

            appDiv.innerHTML = `
                <!-- Navbar -->
                <nav class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-50">
                    <div class="container mx-auto flex justify-between items-center">
                        <div class="font-bold text-xl flex items-center gap-2">
                            <i class="fa-solid fa-wallet"></i> Finance Tracker (NPR)
                        </div>
                        
                        <!-- User Info & Logout -->
                        <div class="flex items-center gap-4">
                            <!-- User Email Display -->
                            <div class="flex items-center gap-2 bg-indigo-700 px-3 py-1.5 rounded-full border border-indigo-500 shadow-sm">
                                <i class="fa-solid fa-circle-user text-indigo-200"></i>
                                <span class="text-sm font-medium text-white truncate max-w-[120px] sm:max-w-xs">${state.user.email}</span>
                            </div>

                            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm font-semibold shadow-sm transition flex items-center gap-2">
                                <i class="fa-solid fa-right-from-bracket"></i> <span class="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </div>
                </nav>

                <div class="container mx-auto p-4 max-w-5xl flex-grow">
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                            <div class="text-gray-500 text-sm font-semibold uppercase">Total Credit</div>
                            <div class="text-2xl font-bold text-green-600">+${totalCredit.toFixed(2)}</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
                            <div class="text-gray-500 text-sm font-semibold uppercase">Total Debit</div>
                            <div class="text-2xl font-bold text-red-600">-${totalDebit.toFixed(2)}</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 ${balance >= 0 ? 'border-indigo-500' : 'border-orange-500'}">
                            <div class="text-gray-500 text-sm font-semibold uppercase">Current Balance</div>
                            <div class="text-2xl font-bold ${balance >= 0 ? 'text-indigo-600' : 'text-orange-600'}">
                                ${balance.toFixed(2)}
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-300 mb-6 bg-white rounded-t-lg overflow-hidden">
                        <button class="flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50 transition ${state.activeTab === 'statement' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'}" onclick="window.switchTab('statement')">
                            <i class="fa-solid fa-list-ul mr-1"></i> Statement
                        </button>
                        <button class="flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50 transition ${state.activeTab === 'credit' ? 'border-b-2 border-green-500 text-green-600' : 'text-gray-600'}" onclick="window.switchTab('credit')">
                            <i class="fa-solid fa-plus-circle mr-1"></i> Add Credit
                        </button>
                        <button class="flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50 transition ${state.activeTab === 'debit' ? 'border-b-2 border-red-500 text-red-600' : 'text-gray-600'}" onclick="window.switchTab('debit')">
                            <i class="fa-solid fa-minus-circle mr-1"></i> Add Debit
                        </button>
                         <button class="flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50 transition ${state.activeTab === 'settings' ? 'border-b-2 border-gray-600 text-gray-800' : 'text-gray-600'}" onclick="window.switchTab('settings')">
                            <i class="fa-solid fa-gear mr-1"></i> Settings
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="bg-white rounded-b-lg shadow p-6 min-h-[300px]">
                        ${renderTabContent()}
                    </div>
                </div>
            `;

            // Attach listeners
            document.getElementById('logoutBtn').addEventListener('click', () => {
                // Clear listener immediately before auth sign out to prevent race conditions
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }
                auth.signOut();
            });
            
            if (document.getElementById('transactionForm')) {
                document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            }
            if (document.getElementById('passwordForm')) {
                document.getElementById('passwordForm').addEventListener('submit', handleChangePassword);
            }
            if (document.getElementById('downloadPdfBtn')) {
                document.getElementById('downloadPdfBtn').addEventListener('click', generatePDF);
            }
            
            // Re-attach edit/delete listeners dynamically
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDelete(e.target.closest('button').dataset.id));
            });
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleEditStart(e.target.closest('button').dataset.id));
            });
        }

        function renderTabContent() {
            if (state.activeTab === 'statement') {
                return `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Transaction History</h2>
                        <button id="downloadPdfBtn" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm">
                            <i class="fa-solid fa-file-pdf mr-1"></i> Download PDF
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 text-sm uppercase">
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Remark</th>
                                    <th class="p-3">Type</th>
                                    <th class="p-3 text-right">Amount</th>
                                    <th class="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${state.transactions.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found.</td></tr>' : 
                                  state.transactions.map(t => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3">${t.date}</td>
                                        <td class="p-3">${t.remark}</td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 rounded text-xs font-bold ${t.type === 'CREDIT' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${t.type}
                                            </span>
                                        </td>
                                        <td class="p-3 text-right font-mono ${t.type === 'CREDIT' ? 'text-green-600' : 'text-red-600'}">
                                            ${t.type === 'CREDIT' ? '+' : '-'}${Number(t.amount).toFixed(2)}
                                        </td>
                                        <td class="p-3 text-center space-x-2">
                                            <button data-id="${t.id}" class="edit-btn text-blue-600 hover:text-blue-800" title="Edit"><i class="fa-solid fa-pen"></i></button>
                                            <button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-800" title="Delete"><i class="fa-solid fa-trash"></i></button>
                                        </td>
                                    </tr>
                                  `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (state.activeTab === 'credit' || state.activeTab === 'debit') {
                const isCredit = state.activeTab === 'credit';
                const type = isCredit ? 'CREDIT' : 'DEBIT';
                const color = isCredit ? 'green' : 'red';
                const editData = state.editingId ? state.transactions.find(t => t.id === state.editingId) : null;
                
                return `
                    <h2 class="text-lg font-bold mb-4 text-${color}-600">${state.editingId ? 'Edit' : 'Add'} ${isCredit ? 'Credit' : 'Debit'}</h2>
                    <form id="transactionForm" class="max-w-lg space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="t-date" value="${editData ? editData.date : new Date().toISOString().split('T')[0]}" class="w-full border border-gray-300 rounded p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="t-amount" value="${editData ? editData.amount : ''}" step="0.01" min="0" class="w-full border border-gray-300 rounded p-2" required placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Remark</label>
                            <input type="text" id="t-remark" value="${editData ? editData.remark : ''}" class="w-full border border-gray-300 rounded p-2" required placeholder="e.g. Salary, Rent">
                        </div>
                        <input type="hidden" id="t-type" value="${type}">
                        
                        <div class="flex gap-2">
                             <button type="submit" class="flex-1 bg-${color}-600 text-white py-2 rounded hover:bg-${color}-700 transition">
                                <i class="fa-solid fa-save mr-1"></i> ${state.editingId ? 'Update' : 'Save'}
                            </button>
                            ${state.editingId ? `<button type="button" onclick="window.cancelEdit()" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-100">Cancel</button>` : ''}
                        </div>
                    </form>
                `;
            } else if (state.activeTab === 'settings') {
                return `
                    <h2 class="text-lg font-bold mb-4 text-gray-800">Change Password</h2>
                    <p class="text-sm text-gray-500 mb-4">To ensure security, please verify your current password before setting a new one.</p>
                    
                    ${state.successMsg ? `<div class="bg-green-100 text-green-700 p-2 mb-2 rounded">${state.successMsg}</div>` : ''}
                    ${state.error ? `<div class="bg-red-100 text-red-700 p-2 mb-2 rounded">${state.error}</div>` : ''}

                    <form id="passwordForm" class="max-w-lg space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input type="password" id="old-pass" class="w-full border border-gray-300 rounded p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">New Password</label>
                            <input type="password" id="new-pass" class="w-full border border-gray-300 rounded p-2" required minlength="6">
                        </div>
                        <button type="submit" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-700">
                            Update Password
                        </button>
                    </form>
                `;
            }
        }

        // ==========================================
        // EVENT HANDLERS
        // ==========================================
        
        window.switchTab = (tab) => {
            state.activeTab = tab;
            state.editingId = null; 
            state.error = '';
            state.successMsg = '';
            render();
        };

        window.cancelEdit = () => {
            state.editingId = null;
            state.activeTab = 'statement';
            render();
        }

        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const passwordInput = document.getElementById('password');
            const password = passwordInput ? passwordInput.value : null;
            
            state.error = '';
            state.successMsg = '';
            state.submitting = true;
            render(); 

            try {
                // Login Only
                await signInWithEmailAndPassword(auth, email, password);
                // On successful login, onAuthStateChanged will trigger checks
            } catch (err) {
                console.error("Auth Error:", err.code, err.message);
                
                if (err.code === 'auth/email-already-in-use') {
                    state.error = "Email already registered.";
                } else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential' || err.code === 'auth/invalid-login-credentials') {
                    state.error = "Invalid email or password.";
                } else if (err.code === 'auth/operation-not-allowed') {
                    state.error = "Login is disabled. Please enable 'Email/Password' in Firebase Console.";
                } else if (err.code === 'auth/too-many-requests') {
                    state.error = "Too many failed attempts. Try again later.";
                } else {
                    state.error = err.message;
                }
                
                state.submitting = false;
                render();
            }
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('t-date').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const remark = document.getElementById('t-remark').value;
            const type = document.getElementById('t-type').value;

            try {
                if (!db) throw new Error("Database connection not initialized.");
                
                if (state.editingId) {
                    const docRef = doc(db, "transactions", state.editingId);
                    await updateDoc(docRef, { date, amount, remark, type });
                    state.editingId = null;
                } else {
                    await addDoc(collection(db, "transactions"), {
                        userId: state.user.uid,
                        date,
                        amount,
                        remark,
                        type,
                        createdAt: Date.now()
                    });
                }
                
                // Success: Switch to statement to show the new record
                state.activeTab = 'statement';
                render();
            } catch (err) {
                console.error("Save Error:", err);
                if (err.message.includes("Missing or insufficient permissions")) {
                     window.showErrorModal("Database permissions are blocked. You need to update your Firebase Rules.", true);
                } else {
                     alert("Error saving transaction: " + err.message);
                }
            }
        }

        async function handleDelete(id) {
            if (confirm("Are you sure you want to delete this record?")) {
                try {
                    await deleteDoc(doc(db, "transactions", id));
                } catch (err) {
                    if (err.message.includes("Missing or insufficient permissions")) {
                         window.showErrorModal("Database permissions are blocked. You need to update your Firebase Rules.", true);
                    } else {
                        alert("Delete failed: " + err.message);
                    }
                }
            }
        }

        function handleEditStart(id) {
            const transaction = state.transactions.find(t => t.id === id);
            if (transaction) {
                state.editingId = id;
                state.activeTab = transaction.type === 'CREDIT' ? 'credit' : 'debit';
                render();
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;
            
            try {
                const credential = EmailAuthProvider.credential(state.user.email, oldPass);
                await reauthenticateWithCredential(state.user, credential);
                
                await updatePassword(state.user, newPass);
                state.successMsg = "Password updated successfully.";
                state.error = "";
                document.getElementById('passwordForm').reset();
                render();
            } catch (err) {
                state.error = "Failed: " + err.message;
                state.successMsg = "";
                render();
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Calculate Totals for PDF
            const totalCredit = state.transactions
                .filter(t => t.type === 'CREDIT')
                .reduce((sum, t) => sum + Number(t.amount), 0);
            
            const totalDebit = state.transactions
                .filter(t => t.type === 'DEBIT')
                .reduce((sum, t) => sum + Number(t.amount), 0);
            
            const balance = totalCredit - totalDebit;

            doc.setFontSize(18);
            doc.text("Finance Tracker Statement", 14, 22);
            doc.setFontSize(11);
            doc.text("User: " + state.user.email, 14, 30);
            doc.text("Date: " + new Date().toLocaleDateString(), 14, 36);

            // Add Summary Information
            doc.setFontSize(10);
            doc.setTextColor(22, 163, 74); // Green
            doc.text(`Total Credit: +${totalCredit.toFixed(2)}`, 14, 46);
            
            doc.setTextColor(220, 38, 38); // Red
            doc.text(`Total Debit: -${totalDebit.toFixed(2)}`, 100, 46);
            
            const balanceColor = balance >= 0 ? [79, 70, 229] : [234, 88, 12]; // Indigo or Orange
            doc.setTextColor(balanceColor[0], balanceColor[1], balanceColor[2]);
            doc.text(`Current Balance: ${balance.toFixed(2)}`, 14, 52);

            doc.setTextColor(0, 0, 0); // Reset to black

            const tableBody = state.transactions.map(t => [
                t.date,
                t.remark,
                t.type,
                (t.type === 'CREDIT' ? '+' : '-') + Number(t.amount).toFixed(2)
            ]);

            doc.autoTable({
                head: [['Date', 'Remark', 'Type', 'Amount']],
                body: tableBody,
                startY: 60, // Pushed down to make room for totals
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] }
            });

            doc.save('statement.pdf');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        onAuthStateChanged(auth, (user) => {
            // Unsubscribe from Snapshot immediately to prevent "Permission Denied" on logout
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }

            if (user) {
                state.user = user;
                
                // Fetch data immediately (removed check for user.emailVerified)
                const q = query(
                    collection(db, "transactions"), 
                    where("userId", "==", user.uid),
                    orderBy("date", "desc")
                );
                
                unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                    state.transactions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    render();
                }, (error) => {
                    // FIX: If user is logged out, suppress the permission error
                    if (!auth.currentUser) return; 

                    console.error("Snapshot Error:", error);
                    if(error.code === 'permission-denied') {
                            window.showErrorModal("Cannot read data. Your Database Rules are blocking access.", true);
                    } else if (error.message && error.message.includes("requires an index")) {
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                        const url = match ? match[0] : null;
                        let msg = "Database requires an index for this query. ";
                        if (url) {
                            msg += `<br><br><a href="${url}" target="_blank" class="text-blue-600 underline font-bold">Click here to create it automatically</a>`;
                        }
                        window.showErrorModal(msg);
                    }
                });
            } else {
                state.user = null;
                state.transactions = [];
                state.view = 'auth';
                // Reset loading state so the login button is enabled
                state.submitting = false;
                state.error = '';
                render();
            }
        });

    </script>
    <script>
  if ('service worker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>

</html>
